!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Virgil={})}(this,(function(t){"use strict";var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(t,e){return t(e={exports:{}},e.exports),e.exports}var n=r((function(t,r){!function(n){var i=r,o=t&&t.exports==i&&t,a="object"==typeof e&&e;a.global!==a&&a.window!==a||(n=a);var s=function(t){this.message=t};(s.prototype=new Error).name="InvalidCharacterError";var u=function(t){throw new s(t)},c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d=/[\t\n\f\r ]/g,f={encode:function(t){t=String(t),/[^\0-\xFF]/.test(t)&&u("The string to be encoded contains characters outside of the Latin1 range.");for(var e,r,n,i,o=t.length%3,a="",s=-1,d=t.length-o;++s<d;)e=t.charCodeAt(s)<<16,r=t.charCodeAt(++s)<<8,n=t.charCodeAt(++s),a+=c.charAt((i=e+r+n)>>18&63)+c.charAt(i>>12&63)+c.charAt(i>>6&63)+c.charAt(63&i);return 2==o?(e=t.charCodeAt(s)<<8,r=t.charCodeAt(++s),a+=c.charAt((i=e+r)>>10)+c.charAt(i>>4&63)+c.charAt(i<<2&63)+"="):1==o&&(i=t.charCodeAt(s),a+=c.charAt(i>>2)+c.charAt(i<<4&63)+"=="),a},decode:function(t){var e=(t=String(t).replace(d,"")).length;e%4==0&&(e=(t=t.replace(/==?$/,"")).length),(e%4==1||/[^+a-zA-Z0-9/]/.test(t))&&u("Invalid character: the string to be decoded is not correctly encoded.");for(var r,n,i=0,o="",a=-1;++a<e;)n=c.indexOf(t.charAt(a)),r=i%4?64*r+n:n,i++%4&&(o+=String.fromCharCode(255&r>>(-2*i&6)));return o},version:"0.1.0"};if(i&&!i.nodeType)if(o)o.exports=f;else for(var h in f)f.hasOwnProperty(h)&&(i[h]=f[h]);else n.base64=f}(e)}));function i(t){return n.decode(t)}function o(t){return n.encode(t)}function a(t){return t=(t=t.split("=")[0]).replace(/\+/g,"-").replace(/\//g,"_")}function s(t){switch((t=t.replace(/-/g,"+").replace(/_/g,"/")).length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("Invalid base64 string")}return t}function u(t){return a(o(t))}function c(t){return i(s(t))}function d(t){var e;return e="number"==typeof t?t:t.getTime(),Math.floor(e/1e3)}var f=function(){function t(t,e,r){if("string"==typeof t){var n=t,i=n.split(".");if(3!==i.length)throw new Error("Wrong JWT format");try{this.header=JSON.parse(c(i[0])),this.body=JSON.parse(c(i[1])),this.signature=s(i[2])}catch(t){throw new Error("Wrong JWT format")}this.unsignedData=i[0]+"."+i[1],this.stringRepresentation=n}else{if("object"!=typeof t||"object"!=typeof e)throw new TypeError("Invalid arguments for function Jwt. Expected a string representation of a token, or header and body as objects");this.header=t,this.body=e,this.signature=r,this.unsignedData=this.headerBase64()+"."+this.bodyBase64(),this.stringRepresentation=null==this.signature?this.unsignedData:this.unsignedData+"."+this.signatureBase64()}}return t.fromString=function(e){return new t(e)},t.prototype.toString=function(){return this.stringRepresentation},t.prototype.identity=function(){if(0!==this.body.sub.indexOf("identity-"))throw new Error("wrong sub format");return this.body.sub.substr("identity-".length)},t.prototype.appId=function(){if(0!==this.body.iss.indexOf("virgil-"))throw new Error("wrong iss format");return this.body.iss.substr("virgil-".length)},t.prototype.isExpired=function(t){void 0===t&&(t=new Date);var e=d(t);return this.body.exp<e},t.prototype.headerBase64=function(){return u(JSON.stringify(this.header))},t.prototype.bodyBase64=function(){return u(JSON.stringify(this.body))},t.prototype.signatureBase64=function(){return a(this.signature)},t}();function h(t,e){if(!t)throw new Error(e)}var p=12e5,l=function(){function t(t){var e,r;r=function(t){return"Invalid JwtGenerator options. `"+t+"` is required"},h(null!=(e=t),"JwtGenerator options must be provided"),h(null!=e.apiKey,r("apiKey")),h(null!=e.apiKeyId,r("apiKeyId")),h(null!=e.appId,r("appId")),h(null!=e.accessTokenSigner,r("accessTokenSigner")),this.appId=t.appId,this.apiKey=t.apiKey,this.apiKeyId=t.apiKeyId,this.accessTokenSigner=t.accessTokenSigner,this.millisecondsToLive=void 0!==t.millisecondsToLive?Number(t.millisecondsToLive):p}return t.prototype.generateToken=function(t,e){if(!t)throw new TypeError("Illegal arguments for function `generateToken`. Argument `identity` is required.");var r=d(new Date),n=d((new Date).getTime()+this.millisecondsToLive),i={iss:"virgil-"+this.appId,sub:"identity-"+t,iat:r,exp:n,ada:e},o={alg:this.accessTokenSigner.getAlgorithm(),kid:this.apiKeyId,typ:"JWT",cty:"virgil-jwt;v=1"},a=new f(o,i),s=this.accessTokenSigner.generateTokenSignature({value:a.unsignedData,encoding:"utf8"},this.apiKey);return new f(o,i,s.toString("base64"))},t}();var y=function(){function t(t){var e,r;r=function(t){return"Invalid JwtVerifier options. `"+t+"` is required"},h(null!=(e=t),"JwtVerifier options must be provided"),h(null!=e.apiPublicKey,r("apiPublicKey")),h(null!=e.apiKeyId,r("apiKeyId")),h(null!=e.accessTokenSigner,r("accessTokenSigner")),this.accessTokenSigner=t.accessTokenSigner,this.apiPublicKey=t.apiPublicKey,this.apiKeyId=t.apiKeyId}return t.prototype.verifyToken=function(t){if(null==t)throw new Error("Token is empty");return!!this.allFieldsAreCorrect(t)&&this.accessTokenSigner.verifyTokenSignature({value:t.unsignedData,encoding:"utf8"},{value:t.signature,encoding:"base64"},this.apiPublicKey)},t.prototype.allFieldsAreCorrect=function(t){return t.header.kid==this.apiKeyId&&t.header.alg==this.accessTokenSigner.getAlgorithm()&&"virgil-jwt;v=1"==t.header.cty&&"JWT"==t.header.typ},t}();var v=5,g=function(){function t(t,e){var r=this;if("function"!=typeof t)throw new TypeError("`renewJwtFn` must be a function");if(e){var n=void 0;if("string"==typeof e)n=f.fromString(e);else{if(!(e instanceof f))throw new Error('Expected "initialToken" to be a string or an instance of Jwt, got '+typeof e);n=e}this.cachedJwt=n}this.getJwt=function(e){return r.cachedJwt&&!r.cachedJwt.isExpired((n=new Date,i=v,"number"==typeof n?new Date(n+1e3*i):new Date(n.getTime()+1e3*i)))?Promise.resolve(r.cachedJwt):r.jwtPromise?r.jwtPromise:(r.jwtPromise=Promise.resolve(t(e)).then((function(t){var e="string"==typeof t?f.fromString(t):t;return r.cachedJwt=e,r.jwtPromise=void 0,e})).catch((function(t){throw r.jwtPromise=void 0,t})),r.jwtPromise);var n,i}}return t.prototype.getToken=function(t){return this.getJwt(t)},t}(),w=function(){function t(t){if("function"!=typeof t)throw new TypeError("`getJwtFn` must be a function");this.getJwt=function(e){return Promise.resolve(t(e)).then((function(t){return"string"==typeof t?f.fromString(t):t}))}}return t.prototype.getToken=function(t){return this.getJwt(t)},t}(),b=function(){function t(t){if(this.accessToken=t,null==t)throw new TypeError("`accessToken` is required")}return t.prototype.getToken=function(t){return Promise.resolve(this.accessToken)},t}(),m=function(){function t(t,e,r){if(this.jwtGenerator=t,this.additionalData=e,this.defaultIdentity=r,null==t)throw new TypeError("`jwtGenerator` is required")}return t.prototype.getToken=function(t){var e=this;return Promise.resolve().then((function(){return e.jwtGenerator.generateToken(t.identity||e.defaultIdentity||"",e.additionalData)}))},t}(),S=function(t,e){return(S=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function E(t,e){function r(){this.constructor=t}S(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var T=function(){return(T=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function x(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(r[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(t);i<n.length;i++)e.indexOf(n[i])<0&&(r[n[i]]=t[n[i]])}return r}function A(t,e,r,n){return new(r||(r=Promise))((function(i,o){function a(t){try{u(n.next(t))}catch(t){o(t)}}function s(t){try{u(n.throw(t))}catch(t){o(t)}}function u(t){t.done?i(t.value):new r((function(e){e(t.value)})).then(a,s)}u((n=n.apply(t,e||[])).next())}))}function C(t,e){var r,n,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}var k,P=function(){function t(t,e){this.contentSnapshot=t,this.signatures=e}return t.fromString=function(e){var r,n=i(e);try{r=JSON.parse(n)}catch(t){throw new Error("The string to be parsed is in invalid format")}return t.fromJson(r)},t.fromJson=function(e){return new t(i(e.content_snapshot),(e.signatures||[]).map((function(t){var e=t.signer,r=t.signature,n=t.snapshot;return n?{signer:e,signature:r,snapshot:i(n)}:{signer:e,signature:r}})))},t.prototype.toJSON=function(){return this.toJson()},t.prototype.toJson=function(){return{content_snapshot:o(this.contentSnapshot),signatures:this.signatures.map((function(t){var e=t.signer,r=t.signature,n=t.snapshot;return n?{signer:e,signature:r,snapshot:o(n)}:{signer:e,signature:r}}))}},t.prototype.toString=function(){return o(JSON.stringify(this))},t.prototype.exportAsJson=function(){return this.toJson()},t.prototype.exportAsString=function(){return this.toString()},t}(),I=r((function(t,r){!function(e){t.exports=function(t){var r=t&&t.Promise||e.Promise,n=t&&t.XMLHttpRequest||e.XMLHttpRequest,i=e;return function(){var t=Object.create(i,{fetch:{value:void 0,writable:!0}});return function(t){if(!t.fetch){var e={searchParams:"URLSearchParams"in t,iterable:"Symbol"in t&&"iterator"in Symbol,blob:"FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(t){return!1}}(),formData:"FormData"in t,arrayBuffer:"ArrayBuffer"in t};if(e.arrayBuffer)var i=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],o=function(t){return t&&DataView.prototype.isPrototypeOf(t)},a=ArrayBuffer.isView||function(t){return t&&i.indexOf(Object.prototype.toString.call(t))>-1};h.prototype.append=function(t,e){t=c(t),e=d(e);var r=this.map[t];this.map[t]=r?r+","+e:e},h.prototype.delete=function(t){delete this.map[c(t)]},h.prototype.get=function(t){return t=c(t),this.has(t)?this.map[t]:null},h.prototype.has=function(t){return this.map.hasOwnProperty(c(t))},h.prototype.set=function(t,e){this.map[c(t)]=d(e)},h.prototype.forEach=function(t,e){for(var r in this.map)this.map.hasOwnProperty(r)&&t.call(e,this.map[r],r,this)},h.prototype.keys=function(){var t=[];return this.forEach((function(e,r){t.push(r)})),f(t)},h.prototype.values=function(){var t=[];return this.forEach((function(e){t.push(e)})),f(t)},h.prototype.entries=function(){var t=[];return this.forEach((function(e,r){t.push([r,e])})),f(t)},e.iterable&&(h.prototype[Symbol.iterator]=h.prototype.entries);var s=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];w.prototype.clone=function(){return new w(this,{body:this._bodyInit})},g.call(w.prototype),g.call(m.prototype),m.prototype.clone=function(){return new m(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new h(this.headers),url:this.url})},m.error=function(){var t=new m(null,{status:0,statusText:""});return t.type="error",t};var u=[301,302,303,307,308];m.redirect=function(t,e){if(-1===u.indexOf(e))throw new RangeError("Invalid status code");return new m(null,{status:e,headers:{location:t}})},t.Headers=h,t.Request=w,t.Response=m,t.fetch=function(t,i){return new r((function(r,o){var a=new w(t,i),s=new n;s.onload=function(){var t,e,n={status:s.status,statusText:s.statusText,headers:(t=s.getAllResponseHeaders()||"",e=new h,t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach((function(t){var r=t.split(":"),n=r.shift().trim();if(n){var i=r.join(":").trim();e.append(n,i)}})),e)};n.url="responseURL"in s?s.responseURL:n.headers.get("X-Request-URL");var i="response"in s?s.response:s.responseText;r(new m(i,n))},s.onerror=function(){o(new TypeError("Network request failed"))},s.ontimeout=function(){o(new TypeError("Network request failed"))},s.open(a.method,a.url,!0),"include"===a.credentials?s.withCredentials=!0:"omit"===a.credentials&&(s.withCredentials=!1),"responseType"in s&&e.blob&&(s.responseType="blob"),a.headers.forEach((function(t,e){s.setRequestHeader(e,t)})),s.send(void 0===a._bodyInit?null:a._bodyInit)}))},t.fetch.polyfill=!0}function c(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function d(t){return"string"!=typeof t&&(t=String(t)),t}function f(t){var r={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return e.iterable&&(r[Symbol.iterator]=function(){return r}),r}function h(t){this.map={},t instanceof h?t.forEach((function(t,e){this.append(e,t)}),this):Array.isArray(t)?t.forEach((function(t){this.append(t[0],t[1])}),this):t&&Object.getOwnPropertyNames(t).forEach((function(e){this.append(e,t[e])}),this)}function p(t){if(t.bodyUsed)return r.reject(new TypeError("Already read"));t.bodyUsed=!0}function l(t){return new r((function(e,r){t.onload=function(){e(t.result)},t.onerror=function(){r(t.error)}}))}function y(t){var e=new FileReader,r=l(e);return e.readAsArrayBuffer(t),r}function v(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function g(){return this.bodyUsed=!1,this._initBody=function(t){if(this._bodyInit=t,t)if("string"==typeof t)this._bodyText=t;else if(e.blob&&Blob.prototype.isPrototypeOf(t))this._bodyBlob=t;else if(e.formData&&FormData.prototype.isPrototypeOf(t))this._bodyFormData=t;else if(e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t))this._bodyText=t.toString();else if(e.arrayBuffer&&e.blob&&o(t))this._bodyArrayBuffer=v(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer]);else{if(!e.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(t)&&!a(t))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=v(t)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},e.blob&&(this.blob=function(){var t=p(this);if(t)return t;if(this._bodyBlob)return r.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return r.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return r.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?p(this)||r.resolve(this._bodyArrayBuffer):this.blob().then(y)}),this.text=function(){var t,e,n,i=p(this);if(i)return i;if(this._bodyBlob)return t=this._bodyBlob,e=new FileReader,n=l(e),e.readAsText(t),n;if(this._bodyArrayBuffer)return r.resolve(function(t){for(var e=new Uint8Array(t),r=new Array(e.length),n=0;n<e.length;n++)r[n]=String.fromCharCode(e[n]);return r.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return r.resolve(this._bodyText)},e.formData&&(this.formData=function(){return this.text().then(b)}),this.json=function(){return this.text().then(JSON.parse)},this}function w(t,e){var r,n,i=(e=e||{}).body;if(t instanceof w){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new h(t.headers)),this.method=t.method,this.mode=t.mode,i||null==t._bodyInit||(i=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"omit",!e.headers&&this.headers||(this.headers=new h(e.headers)),this.method=(r=e.method||this.method||"GET",n=r.toUpperCase(),s.indexOf(n)>-1?n:r),this.mode=e.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&i)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(i)}function b(t){var e=new FormData;return t.trim().split("&").forEach((function(t){if(t){var r=t.split("="),n=r.shift().replace(/\+/g," "),i=r.join("=").replace(/\+/g," ");e.append(decodeURIComponent(n),decodeURIComponent(i))}})),e}function m(t,e){e||(e={}),this.type="default",this.status=void 0===e.status?200:e.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in e?e.statusText:"OK",this.headers=new h(e.headers),this.url=e.url||"",this._initBody(t)}}(void 0!==t?t:this),{fetch:t.fetch,Headers:t.Headers,Request:t.Request,Response:t.Response}}()}}("undefined"!=typeof self?self:e)}))(),_=I.fetch,O=(I.Request,I.Response,I.Headers),j=[{name:"Windows Phone",test:[/windows phone/i]},{test:[/windows/i],name:"Windows"},{test:[/macintosh/i],name:"macOS"},{test:[/(ipod|iphone|ipad)/i],name:"iOS"},{test:[/android/i],name:"Android"},{test:[/linux/i],name:"Linux"},{test:[/CrOS/],name:"Chrome OS"},{test:[/PlayStation 4/],name:"PlayStation 4"}],K=[{test:[/googlebot/i],name:"Googlebot"},{test:[/opera/i,/opr\/|opios/i],name:"Opera"},{test:[/msie|trident/i],name:"Internet Explorer"},{test:[/\sedg/i],name:"Microsoft Edge"},{test:[/firefox|iceweasel|fxios/i],name:"Firefox"},{test:[/chromium/i],name:"Chromium"},{test:[/chrome|crios|crmo/i],name:"Chrome"},{test:[/android/i],name:"Android Browser"},{test:[/playstation 4/i],name:"PlayStation 4"},{test:[/safari|applewebkit/i],name:"Safari"}],D=function(){function t(t,e,r){var n=this;this.isIonic=function(){return"undefined"!=typeof window&&!!("cordova"in window||"phonegap"in window||"PhoneGap"in window)&&/android|ios|iphone|ipod|ipad|iemobile/i.test(n.userAgent)},this.userAgent=r||this.getUserAgent(),this.value=t+";js;"+this.getHeaderValue()+";"+e}return t.prototype.getUserAgent=function(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""},t.prototype.getOsName=function(){var t=this,e=j.find((function(e){return e.test.some((function(e){return e.test(t.userAgent)}))}));return e?e.name:"other"},t.prototype.getBrowser=function(){var t=this,e=K.find((function(e){return e.test.some((function(e){return e.test(t.userAgent)}))}));return e?e.name:"other"},t.prototype.isReactNative=function(){return"object"==typeof navigator&&"ReactNative"===navigator.product},t.prototype.getHeaderValue=function(){try{return this.isReactNative()?"ReactNative":this.isIonic()?"Ionic/"+this.getOsName():this.getBrowser()+"/"+this.getOsName()}catch(t){return"Unknown"}},t}(),J=function(){function t(t,e){this.prefix=t,e||(e={product:"sdk",version:"6.0.0-alpha.5"}),this.virgilAgentValue=new D(e.product,e.version).value}return t.prototype.get=function(t,e){var r=this.createHeaders(e);return this.send(t,"GET",{headers:r})},t.prototype.post=function(t,e,r){void 0===r&&(r={});var n=this.createHeaders(e);return n.set("Content-Type","application/json"),this.send(t,"POST",{headers:n,body:JSON.stringify(r)})},t.prototype.send=function(t,e,r){return _(this.prefix+t,T({method:e},r))},t.prototype.createHeaders=function(t){var e=new O;return e.set("Authorization","Virgil "+t),e.set("Virgil-Agent",this.virgilAgentValue),e},t}(),B=function(t){function e(r,n,i){void 0===n&&(n="VirgilError"),void 0===i&&(i=e);var o=t.call(this,r)||this;return Object.setPrototypeOf(o,i.prototype),o.name=n,o}return E(e,t),e}(Error);!function(t){t[t.AccessTokenExpired=20304]="AccessTokenExpired",t[t.Unknown=0]="Unknown"}(k||(k={}));var R=function(t){function e(r,n,i){var o=t.call(this,r,"VirgilHttpError",e)||this;return o.httpStatus=n,o.errorCode=i,o}return E(e,t),e}(B);function N(t){return A(this,void 0,void 0,(function(){var e;return C(this,(function(r){switch(r.label){case 0:return t.status>=400&&t.status<500?[4,t.json()]:[3,2];case 1:return e=r.sent(),[2,new R(e.message,t.status,e.code)];case 2:return[2,new R(t.statusText,t.status,0)]}}))}))}var V=function(t){return"/card/v5/"+t},U=function(t){return"/card/v5/actions/revoke/"+t},F=function(){function t(t,e){this.connection="string"==typeof t?new J(t,e):t||new J("https://api.virgilsecurity.com",e)}return t.prototype.searchCards=function(t,e){return A(this,void 0,void 0,(function(){var r,n;return C(this,(function(i){switch(i.label){case 0:return[4,this.connection.post("/card/v5/actions/search",e,{identities:t})];case 1:return(r=i.sent()).ok?[3,3]:[4,N(r)];case 2:throw i.sent();case 3:return[4,r.json()];case 4:return null===(n=i.sent())?[2,[]]:[2,n.map(P.fromJson)]}}))}))},t.prototype.getCard=function(t,e){return A(this,void 0,void 0,(function(){var r,n,i;return C(this,(function(o){switch(o.label){case 0:if(!t)throw new TypeError("`cardId` should not be empty");if(!e)throw new TypeError("`accessToken` should not be empty");return[4,this.connection.get(V(t),e)];case 1:return(r=o.sent()).ok?[3,3]:[4,N(r)];case 2:throw o.sent();case 3:return n="true"===r.headers.get("X-Virgil-Is-Superseeded"),[4,r.json()];case 4:return i=o.sent(),[2,{cardRaw:P.fromJson(i),isOutdated:n}]}}))}))},t.prototype.publishCard=function(t,e){return A(this,void 0,void 0,(function(){var r,n;return C(this,(function(i){switch(i.label){case 0:if(!t)throw new TypeError("`model` should not be empty");if(!e)throw new TypeError("`accessToken` should not be empty");return[4,this.connection.post("/card/v5",e,t)];case 1:return(r=i.sent()).ok?[3,3]:[4,N(r)];case 2:throw i.sent();case 3:return[4,r.json()];case 4:return n=i.sent(),[2,P.fromJson(n)]}}))}))},t.prototype.revokeCard=function(t,e){return A(this,void 0,void 0,(function(){var r;return C(this,(function(n){switch(n.label){case 0:if(!t)throw new TypeError("`cardId` should not be empty");if(!e)throw new TypeError("`accessToken` should not be empty");return[4,this.connection.post(U(t),e)];case 1:return(r=n.sent()).ok?[3,3]:[4,N(r)];case 2:throw n.sent();case 3:return[2]}}))}))},t}(),q="5.0",L=32,H=function(){function t(t){this.crypto=t}return t.prototype.sign=function(t){var e=this.prepareParams(t),r=e.model,n=e.signerPrivateKey,i=e.signer,o=e.extraSnapshot,a=null!=o?r.contentSnapshot+o:r.contentSnapshot,s=this.crypto.generateSignature({value:a,encoding:"utf8"},n);r.signatures.push({signer:i,signature:s.toString("base64"),snapshot:o})},t.prototype.prepareParams=function(t){var e,r=t.model,n=t.signerPrivateKey,i=t.extraFields,o=t.signer;o=o||"self",null!=i&&(e=JSON.stringify(i));var a={model:r,signerPrivateKey:n,signer:o,extraSnapshot:e};return this.validate(a),a},t.prototype.validate=function(t){var e=t.model,r=t.signerPrivateKey,n=t.signer;if(null==e)throw new Error("Model is empty");if(null==r)throw new Error("`signerPrivateKey` property is mandatory");if(null!=e.signatures&&e.signatures.some((function(t){return t.signer==n})))throw new Error("The model already has this signature.")},t}();function G(t,e,r){void 0===r&&(r=!1);var n=JSON.parse(e.contentSnapshot),i=e.signatures.map(z);return{id:W(t,e.contentSnapshot),publicKey:t.importPublicKey({value:n.public_key,encoding:"base64"}),contentSnapshot:e.contentSnapshot,identity:n.identity,version:n.version,createdAt:new Date(1e3*n.created_at),previousCardId:n.previous_card_id,signatures:i,isOutdated:r}}function M(t){for(var e=Object.create(null),r=0,n=t;r<n.length;r++){var i=n[r];e[i.id]=i}for(var o=0,a=t;o<a.length;o++){null!=(i=a[o]).previousCardId&&(null!=e[i.previousCardId]&&(e[i.previousCardId].isOutdated=!0,i.previousCard=e[i.previousCardId],delete e[i.previousCardId]))}return Object.keys(e).map((function(t){return e[t]}))}function W(t,e){return t.generateSha512({value:e,encoding:"utf8"}).slice(0,L).toString("hex")}function z(t){var e=t.snapshot,r=t.signature;return{signer:t.signer,signature:r,snapshot:e,extraFields:X(e)}}function X(t){if(t)try{return JSON.parse(t)}catch(t){}return{}}var Y=function(t){function e(r){return t.call(this,r,"CardVerificationError",e)||this}return E(e,t),e}(B),Z={getToken:function(){throw new Error("Please set `CardManager.accessTokenProvider` to be able to make requests.")}},Q=function(t){return T(T({},t),{service:"cards"})},$=function(){function t(t){this.crypto=t.cardCrypto,this.client=new F(t.apiUrl,t.productInfo),this.modelSigner=new H(t.cardCrypto),this.signCallback=t.signCallback,this.retryOnUnauthorized=t.retryOnUnauthorized,this.cardVerifier=t.cardVerifier,this.accessTokenProvider=t.accessTokenProvider||Z}return t.prototype.generateRawCard=function(t){var e,r,n,i,o,a=(e=this.crypto,n=(r=t).identity,i=r.publicKey,o={identity:n,previous_card_id:r.previousCardId,created_at:d(new Date),version:q,public_key:e.exportPublicKey(i).toString("base64")},new P(JSON.stringify(o),[]));return this.modelSigner.sign({model:a,signerPrivateKey:t.privateKey,signer:"self",extraFields:t.extraFields}),a},t.prototype.publishCard=function(t){return A(this,void 0,void 0,(function(){var e,r,n;return C(this,(function(i){switch(i.label){case 0:return function(t,e){void 0===e&&(e=!1);h(null!=t,"Card parameters must be provided"),h(null!=t.privateKey,"Card's private key is required"),h(null!=t.publicKey,"Card's public key is required"),e&&h("string"==typeof t.identity&&""!==t.identity,"Card's identity is required")}(t),e={service:"cards",identity:t.identity,operation:"publish"},[4,this.accessTokenProvider.getToken(e)];case 1:return r=i.sent(),n=this.generateRawCard(Object.assign({},t,{identity:r.identity()})),[4,this.publishRawSignedModel(n,e,r)];case 2:return[2,i.sent()]}}))}))},t.prototype.publishRawCard=function(t){return A(this,void 0,void 0,(function(){var e,r,n;return C(this,(function(i){switch(i.label){case 0:return h(null!=t&&null!=t.contentSnapshot,"`rawCard` should not be empty"),e=JSON.parse(t.contentSnapshot),r=Q({identity:e.identity,operation:"publish"}),[4,this.accessTokenProvider.getToken(r)];case 1:return n=i.sent(),[2,this.publishRawSignedModel(t,r,n)]}}))}))},t.prototype.getCard=function(t){return A(this,void 0,void 0,(function(){var e,r,n,i,o=this;return C(this,(function(a){switch(a.label){case 0:return e=Q({operation:"get"}),[4,this.accessTokenProvider.getToken(e)];case 1:return r=a.sent(),[4,this.tryDo(e,r,(function(e){return A(o,void 0,void 0,(function(){return C(this,(function(r){switch(r.label){case 0:return[4,this.client.getCard(t,e.toString())];case 1:return[2,r.sent()]}}))}))}))];case 2:if(n=a.sent(),(i=G(this.crypto,n.cardRaw,n.isOutdated)).id!==t)throw new Y("Received invalid card");return this.validateCards([i]),[2,i]}}))}))},t.prototype.searchCards=function(t){return A(this,void 0,void 0,(function(){var e,r,n,i,o,a,s=this;return C(this,(function(u){switch(u.label){case 0:if(!t)throw new TypeError("Argument `identities` is required");if(0===(e=Array.isArray(t)?t:[t]).length)throw new TypeError("Identities array must not be empty");return r=Q({operation:"search"}),[4,this.accessTokenProvider.getToken(r)];case 1:return n=u.sent(),[4,this.tryDo(r,n,(function(t){return A(s,void 0,void 0,(function(){return C(this,(function(r){switch(r.label){case 0:return[4,this.client.searchCards(e,t.toString())];case 1:return[2,r.sent()]}}))}))}))];case 2:if(i=u.sent(),o=i.map((function(t){return G(s.crypto,t,!1)})),a=new Set(e),o.some((function(t){return!a.has(t.identity)})))throw new Y("Received invalid cards");return this.validateCards(o),[2,M(o)]}}))}))},t.prototype.revokeCard=function(t){return A(this,void 0,void 0,(function(){var e,r,n=this;return C(this,(function(i){switch(i.label){case 0:if(!t)throw new TypeError("Argument `cardId` is required");return e=Q({operation:"revoke"}),[4,this.accessTokenProvider.getToken(e)];case 1:return r=i.sent(),[4,this.tryDo(e,r,(function(e){return A(n,void 0,void 0,(function(){return C(this,(function(r){switch(r.label){case 0:return[4,this.client.revokeCard(t,e.toString())];case 1:return[2,r.sent()]}}))}))}))];case 2:return i.sent(),[2]}}))}))},t.prototype.importCard=function(t){var e=G(this.crypto,t);return this.validateCards([e]),e},t.prototype.importCardFromString=function(t){return h(Boolean(t),"`str` should not be empty"),this.importCard(P.fromString(t))},t.prototype.importCardFromJson=function(t){return h(Boolean(t),"`json` should not be empty"),this.importCard(P.fromJson(t))},t.prototype.exportCard=function(t){return function(t){return new P(t.contentSnapshot,t.signatures.slice())}(t)},t.prototype.exportCardAsString=function(t){return this.exportCard(t).toString()},t.prototype.exportCardAsJson=function(t){return this.exportCard(t).toJson()},t.prototype.publishRawSignedModel=function(t,e,r){return A(this,void 0,void 0,(function(){var n,i,o=this;return C(this,(function(a){switch(a.label){case 0:return null==this.signCallback?[3,2]:[4,this.signCallback(t)];case 1:t=a.sent(),a.label=2;case 2:return[4,this.tryDo(e,r,(function(e){return A(o,void 0,void 0,(function(){return C(this,(function(r){switch(r.label){case 0:return[4,this.client.publishCard(t,e.toString())];case 1:return[2,r.sent()]}}))}))}))];case 3:if(n=a.sent(),t.contentSnapshot!==n.contentSnapshot)throw new Y("Received invalid card");return i=G(this.crypto,n),this.validateCards([i]),[2,i]}}))}))},t.prototype.tryDo=function(t,e,r){return A(this,void 0,void 0,(function(){var n;return C(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,6]),[4,r(e)];case 1:return[2,i.sent()];case 2:return(n=i.sent())instanceof R&&401===n.httpStatus&&n.errorCode===k.AccessTokenExpired&&this.retryOnUnauthorized?[4,this.accessTokenProvider.getToken(Q({identity:t.identity,operation:t.operation,forceReload:!0}))]:[3,5];case 3:return e=i.sent(),[4,r(e)];case 4:return[2,i.sent()];case 5:throw n;case 6:return[2]}}))}))},t.prototype.validateCards=function(t){if(null!=this.cardVerifier)for(var e=0,r=t;e<r.length;e++){var n=r[e];if(!this.cardVerifier.verifyCard(n))throw new Y("Validation errors have been detected")}},t}();var tt={verifySelfSignature:!0,verifyVirgilSignature:!0,whitelists:[]},et="MCowBQYDK2VwAyEAljOYGANYiVq1WbvVvoYIKtvZi2ji9bAhxyu6iV/LF8M=",rt=function(){function t(t,e){this.crypto=t;var r=T(T({},tt),e||{});this.verifySelfSignature=r.verifySelfSignature,this.verifyVirgilSignature=r.verifyVirgilSignature,this.whitelists=r.whitelists,this.virgilCardsPublicKey=t.importPublicKey({value:et,encoding:"base64"})}return t.prototype.verifyCard=function(t){var e=this;if(this.selfValidationFailed(t))return!1;if(this.virgilValidationFailed(t))return!1;if(!this.whitelists||0===this.whitelists.length)return!0;for(var r=t.signatures.map((function(t){return t.signer})),n=0,i=this.whitelists;n<i.length;n++){var o=i[n];if(null==o||0===o.length)return!1;var a=o.filter((function(t){return-1!==r.indexOf(t.signer)}));if(0===a.length)return!1;if(!a.some((function(r){return e.validateSignerSignature(t,e.getPublicKey(r.publicKeyBase64),r.signer)})))return!1}return!0},t.prototype.selfValidationFailed=function(t){return this.verifySelfSignature&&!this.validateSignerSignature(t,t.publicKey,"self")},t.prototype.virgilValidationFailed=function(t){return this.verifyVirgilSignature&&!this.validateSignerSignature(t,this.virgilCardsPublicKey,"virgil")},t.prototype.getPublicKey=function(t){return this.crypto.importPublicKey({value:t,encoding:"base64"})},t.prototype.validateSignerSignature=function(t,e,r){var n=t.signatures.find((function(t){return t.signer===r}));if(null==n)return!1;var i=null==n.snapshot?t.contentSnapshot:t.contentSnapshot+n.snapshot;return this.crypto.verifySignature({value:i,encoding:"utf8"},{value:n.signature,encoding:"base64"},e)},t}(),nt=r((function(t,e){!function(t){var e,r,n,i=String.fromCharCode;function o(t){for(var e,r,n=[],i=0,o=t.length;i<o;)(e=t.charCodeAt(i++))>=55296&&e<=56319&&i<o?56320==(64512&(r=t.charCodeAt(i++)))?n.push(((1023&e)<<10)+(1023&r)+65536):(n.push(e),i--):n.push(e);return n}function a(t){if(t>=55296&&t<=57343)throw Error("Lone surrogate U+"+t.toString(16).toUpperCase()+" is not a scalar value")}function s(t,e){return i(t>>e&63|128)}function u(t){if(0==(4294967168&t))return i(t);var e="";return 0==(4294965248&t)?e=i(t>>6&31|192):0==(4294901760&t)?(a(t),e=i(t>>12&15|224),e+=s(t,6)):0==(4292870144&t)&&(e=i(t>>18&7|240),e+=s(t,12),e+=s(t,6)),e+=i(63&t|128)}function c(){if(n>=r)throw Error("Invalid byte index");var t=255&e[n];if(n++,128==(192&t))return 63&t;throw Error("Invalid continuation byte")}function d(){var t,i;if(n>r)throw Error("Invalid byte index");if(n==r)return!1;if(t=255&e[n],n++,0==(128&t))return t;if(192==(224&t)){if((i=(31&t)<<6|c())>=128)return i;throw Error("Invalid continuation byte")}if(224==(240&t)){if((i=(15&t)<<12|c()<<6|c())>=2048)return a(i),i;throw Error("Invalid continuation byte")}if(240==(248&t)&&(i=(7&t)<<18|c()<<12|c()<<6|c())>=65536&&i<=1114111)return i;throw Error("Invalid UTF-8 detected")}t.version="3.0.0",t.encode=function(t){for(var e=o(t),r=e.length,n=-1,i="";++n<r;)i+=u(e[n]);return i},t.decode=function(t){e=o(t),r=e.length,n=0;for(var a,s=[];!1!==(a=d());)s.push(a);return function(t){for(var e,r=t.length,n=-1,o="";++n<r;)(e=t[n])>65535&&(o+=i((e-=65536)>>>10&1023|55296),e=56320|1023&e),o+=i(e);return o}(s)}}(e)}));var it=function(t){function e(r){return t.call(this,"Storage entry "+(r?"with key "+name:"with the given key")+"already exists","StorageEntryAlreadyExistsError",e)||this}return E(e,t),e}(B),ot={},at=function(){function t(t){var e=this;if(this._initStorage=function(){var t={db:null,name:e._defaultConfig.name,storeName:e._defaultConfig.storeName,version:e._defaultConfig.version},r=ot[t.name];return r||(r={db:null,dbReady:null,deferredOperations:[]},ot[t.name]=r),Promise.resolve().then((function(){return t.db=r.db,ct(t)})).then((function(r){return t.db=r,ft(t,e._defaultConfig.version)?dt(t):r})).then((function(n){t.db=r.db=n,e._dbInfo=t}))},this.ready=function(){return e._ready.then((function(){var t=ot[e._dbInfo.name];if(t&&t.dbReady)return t.dbReady}))},!function(){try{return"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(t){return!1}}())throw new Error("Cannot use IndexedDbStorageAdapter. indexedDb is not supported");this._defaultConfig={name:t.name,version:1,storeName:"keyvaluepairs"},this._ready=this._initStorage()}return t.prototype.store=function(t,e){var r=this;return t=lt(t),new Promise((function(n,i){r.ready().then((function(){pt(r._dbInfo,"readwrite",(function(o,a){if(o)return i(o);try{var s=a.objectStore(r._dbInfo.storeName).add(e,t);a.oncomplete=function(){n()},a.onabort=a.onerror=function(){var e=s.error?s.error:s.transaction.error;e&&"ConstraintError"===e.name&&i(new it(t)),i(e)}}catch(t){i(t)}}))})).catch(i)}))},t.prototype.load=function(t){var e=this;return t=lt(t),new Promise((function(r,n){e.ready().then((function(){pt(e._dbInfo,"readonly",(function(i,o){if(i)return n(i);try{var a=o.objectStore(e._dbInfo.storeName).get(t);a.onsuccess=function(){if(null==a.result)return r(null);r(yt(a.result))},a.onerror=function(){n(a.error)}}catch(t){n(t)}}))})).catch(n)}))},t.prototype.exists=function(t){var e=this;return t=lt(t),new Promise((function(r,n){e.ready().then((function(){pt(e._dbInfo,"readonly",(function(i,o){if(i)return n(i);try{var a=o.objectStore(e._dbInfo.storeName).openCursor(t);a.onsuccess=function(){var t=a.result;r(null!==t)},a.onerror=function(){n(a.error)}}catch(t){n(t)}}))})).catch(n)}))},t.prototype.remove=function(t){var e=this;return t=lt(t),new Promise((function(r,n){e.ready().then((function(){pt(e._dbInfo,"readwrite",(function(i,o){if(i)return n(i);try{var a,s=o.objectStore(e._dbInfo.storeName),u=s.count(t);u.onsuccess=function(){if(0===u.result)return r(!1);(a=s.delete(t)).onsuccess=function(){return r(!0)}},o.onabort=o.onerror=function(){var t=a||u,e=t.error?t.error:t.transaction.error;n(e)}}catch(t){n(t)}}))})).catch(n)}))},t.prototype.update=function(t,e){var r=this;return t=lt(t),new Promise((function(n,i){r.ready().then((function(){pt(r._dbInfo,"readwrite",(function(o,a){if(o)return i(o);try{var s=a.objectStore(r._dbInfo.storeName).put(e,t);s.onsuccess=function(){n()},s.onerror=function(){i(s.error)}}catch(t){i(t)}}))})).catch(i)}))},t.prototype.clear=function(){var t=this;return new Promise((function(e,r){t.ready().then((function(){pt(t._dbInfo,"readwrite",(function(n,i){if(n)return r(n);try{var o=i.objectStore(t._dbInfo.storeName).clear();i.oncomplete=function(){return e()},i.onabort=i.onerror=function(){var t=o.error?o.error:o.transaction.error;r(t)}}catch(t){r(t)}}))})).catch(r)}))},t.prototype.list=function(){var t=this;return new Promise((function(e,r){t.ready().then((function(){pt(t._dbInfo,"readonly",(function(n,i){if(n)return r(n);try{var o=i.objectStore(t._dbInfo.storeName).openCursor(),a=[];o.onsuccess=function(){var t=o.result;t?(a.push(yt(t.value)),t.continue()):e(a)},o.onerror=function(){r(o.error)}}catch(t){r(t)}}))})).catch(r)}))},t}();function st(t){var e=ot[t.name],r={};r.promise=new Promise((function(t,e){r.resolve=t,r.reject=e})),e.deferredOperations.push(r),e.dbReady?e.dbReady=e.dbReady.then((function(){return r.promise})):e.dbReady=r.promise}function ut(t,e){return new Promise((function(r,n){if(ot[t.name]=ot[t.name]||{db:null,dbReady:null,deferredOperations:[]},t.db){if(!e)return r(t.db);st(t),t.db.close()}var i=[t.name];e&&i.push(String(t.version));var o=indexedDB.open.apply(indexedDB,i);e&&(o.onupgradeneeded=function(e){var r=o.result;try{r.createObjectStore(t.storeName)}catch(r){if("ConstraintError"!==r.name)throw r;console.warn('The database "'+t.name+'" has been upgraded from version '+e.oldVersion+" to version "+e.newVersion+', but the storage "'+t.storeName+'" already exists.')}}),o.onerror=function(t){t.preventDefault(),n(o.error)},o.onsuccess=function(){r(o.result),function(t){var e=ot[t.name].deferredOperations.pop();if(e)e.resolve(),e.promise}(t)}}))}function ct(t){return ut(t,!1)}function dt(t){return ut(t,!0)}function ft(t,e){if(!t.db)return!0;var r=!t.db.objectStoreNames.contains(t.storeName),n=t.version<t.db.version,i=t.version>t.db.version;if(n&&(t.version!==e&&console.warn('The database "'+t.name+"\" can't be downgraded from version "+t.db.version+" to version "+t.version+"."),t.version=t.db.version),i||r){if(r){var o=t.db.version+1;o>t.version&&(t.version=o)}return!0}return!1}function ht(t){st(t);var e=ot[t.name];return t.db=null,ct(t).then((function(e){return t.db=e,ft(t)?dt(t):e})).then((function(r){t.db=e.db=r})).catch((function(e){throw function(t,e){var r=ot[t.name].deferredOperations.pop();if(r)r.reject(e),r.promise}(t,e),e}))}function pt(t,e,r,n){void 0===n&&(n=1);try{var i=t.db.transaction(t.storeName,e);r(null,i)}catch(i){n>0&&(!t.db||"InvalidStateError"===i.name||"NotFoundError"===i.name)&&Promise.resolve().then((function(){if(!t.db||"NotFoundError"===i.name&&!t.db.objectStoreNames.contains(t.storeName)&&t.version<=t.db.version)return t.db&&(t.version=t.db.version+1),dt(t)})).then((function(){return ht(t).then((function(){pt(t,e,r,n-1)}))})).catch(r),r(i)}}function lt(t){return"string"!=typeof t&&(console.warn(t+" used as a key, but it is not a string."),t=String(t)),t}function yt(t){if(t instanceof ArrayBuffer){var e=new Uint8Array(t);return nt.decode(String.fromCharCode.apply(null,e))}if("string"==typeof t)return t;throw new TypeError("Unknown value format")}var vt=function(t){function e(r){return void 0===r&&(r="Private key with same name already exists"),t.call(this,r,"PrivateKeyExistsError",e)||this}return E(e,t),e}(B),gt={dir:".virgil_keys",name:"VirgilKeys"},wt=function(){function t(t){void 0===t&&(t={}),console.log("Warning! `KeyStorage` is deprecated. Use `PrivateKeyStorage` instead."),this.adapter=function(t){if("string"==typeof t)return new at({dir:t,name:t});var e=t.adapter,r=x(t,["adapter"]);if(null!=e)return e;return new at(T(T({},gt),r))}(t)}return t.prototype.exists=function(t){return bt(t),this.adapter.exists(t)},t.prototype.load=function(t){return bt(t),this.adapter.load(t)},t.prototype.remove=function(t){return bt(t),this.adapter.remove(t)},t.prototype.save=function(t,e){return bt(t),this.adapter.store(t,e).catch((function(t){return t&&"EEXIST"===t.code?Promise.reject(new vt):Promise.reject(t)}))},t}();function bt(t){if(!t)throw new TypeError("Argument `name` is required.")}var mt=function(t){function e(r){return void 0===r&&(r="Loaded key entry was in invalid format."),t.call(this,r,"InvalidKeyEntryError",e)||this}return E(e,t),e}(B),St=function(t){function e(r){return t.call(this,"Key entry "+(r?"named "+r:"with same name")+"already exists","KeyEntryAlreadyExistsError",e)||this}return E(e,t),e}(B),Et=function(t){function e(r){return t.call(this,"Key entry "+(r?"named "+r:"with the given name")+" does not exist.","KeyEntryDoesNotExistError",e)||this}return E(e,t),e}(B),Tt={dir:".virgil_key_entries",name:"VirgilKeyEntries"},xt="creationDate",At="modificationDate",Ct=function(){function t(t){void 0===t&&(t={}),this.adapter=function(t){if("string"==typeof t)return new at({dir:t,name:t});var e=t.adapter,r=x(t,["adapter"]);if(null!=e)return e;return new at(T(T({},Tt),r))}(t)}return t.prototype.exists=function(t){return _t(t),this.adapter.exists(t)},t.prototype.load=function(t){return _t(t),this.adapter.load(t).then((function(t){return null==t?null:Pt(t)}))},t.prototype.remove=function(t){return _t(t),this.adapter.remove(t)},t.prototype.save=function(t){var e=t.name,r=t.value,n=t.meta;Ot(e),jt(r);var i={name:e,value:r,meta:n,creationDate:new Date,modificationDate:new Date};return this.adapter.store(e,kt(i)).then((function(){return i})).catch((function(t){if(t&&"StorageEntryAlreadyExistsError"===t.name)throw new St(e);throw t}))},t.prototype.list=function(){return this.adapter.list().then((function(t){return t.map((function(t){return Pt(t)}))}))},t.prototype.update=function(t){var e=this,r=t.name,n=t.value,i=t.meta;if(Ot(r),!n&&!i)throw new TypeError("Invalid argument. Either `value` or `meta` property is required.");return this.adapter.load(r).then((function(t){if(null===t)throw new Et(r);var o=Pt(t),a=Object.assign(o,{value:n||o.value,meta:i||o.meta,modificationDate:new Date});return e.adapter.update(r,kt(a)).then((function(){return a}))}))},t.prototype.clear=function(){return this.adapter.clear()},t}();function kt(t){return JSON.stringify(t)}function Pt(t){try{return JSON.parse(t,(function(t,e){return t===xt||t===At?new Date(e):e}))}catch(t){throw new mt}}var It=function(t){return function(e){if(!e)throw new TypeError("Invalid argument. Property "+t+" is required")}},_t=function(t){return function(e){if(!e)throw new TypeError("Argument '"+t+"' is required.")}}("name"),Ot=It("name"),jt=It("value"),Kt=function(){function t(t,e){void 0===e&&(e=new Ct),this.privateKeyExporter=t,this.keyEntryStorage=e}return t.prototype.store=function(t,e,r){return A(this,void 0,void 0,(function(){var n,i;return C(this,(function(o){switch(o.label){case 0:n=this.privateKeyExporter.exportPrivateKey(e),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.keyEntryStorage.save({name:t,value:n.toString("base64"),meta:r})];case 2:return o.sent(),[3,4];case 3:if((i=o.sent())&&"KeyEntryAlreadyExistsError"===i.name)throw new vt("Private key with the name "+t+" already exists.");throw i;case 4:return[2]}}))}))},t.prototype.load=function(t){return A(this,void 0,void 0,(function(){var e;return C(this,(function(r){switch(r.label){case 0:return[4,this.keyEntryStorage.load(t)];case 1:return null===(e=r.sent())?[2,null]:[2,{privateKey:this.privateKeyExporter.importPrivateKey(e.value),meta:e.meta}]}}))}))},t.prototype.delete=function(t){return A(this,void 0,void 0,(function(){return C(this,(function(e){switch(e.label){case 0:return[4,this.keyEntryStorage.remove(t)];case 1:return e.sent(),[2]}}))}))},t}();t.CachingJwtProvider=g,t.CallbackJwtProvider=w,t.CardManager=$,t.ConstAccessTokenProvider=b,t.DefaultStorageAdapter=at,t.GeneratorJwtProvider=m,t.InvalidKeyEntryError=mt,t.Jwt=f,t.JwtGenerator=l,t.JwtVerifier=y,t.KeyEntryAlreadyExistsError=St,t.KeyEntryDoesNotExistError=Et,t.KeyEntryStorage=Ct,t.KeyStorage=wt,t.ModelSigner=H,t.PrivateKeyStorage=Kt,t.RawSignedModel=P,t.StorageEntryAlreadyExistsError=it,t.VirgilAgent=D,t.VirgilCardVerifier=rt,Object.defineProperty(t,"__esModule",{value:!0})}));
