!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("virgil-sdk")):"function"==typeof define&&define.amd?define(["exports","virgil-sdk"],t):t((e=e||self).Keyknox={},e.Virgil)}(this,(function(e,t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function r(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}function n(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(s,a)}c((n=n.apply(e,t||[])).next())}))}var i=function(e,t){return function(){for(var r=new Array(arguments.length),n=0;n<r.length;n++)r[n]=arguments[n];return e.apply(t,r)}},o=Object.prototype.toString;
/*!
     * Determine if an object is a Buffer
     *
     * @author   Feross Aboukhadijeh <https://feross.org>
     * @license  MIT
     */function s(e){return"[object Array]"===o.call(e)}function a(e){return null!==e&&"object"==typeof e}function c(e){return"[object Function]"===o.call(e)}function u(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),s(e))for(var r=0,n=e.length;r<n;r++)t.call(null,e[r],r,e);else for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.call(null,e[i],i,e)}var d={isArray:s,isArrayBuffer:function(e){return"[object ArrayBuffer]"===o.call(e)},isBuffer:function(e){return null!=e&&null!=e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){return"undefined"!=typeof FormData&&e instanceof FormData},isArrayBufferView:function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&e.buffer instanceof ArrayBuffer},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:a,isUndefined:function(e){return void 0===e},isDate:function(e){return"[object Date]"===o.call(e)},isFile:function(e){return"[object File]"===o.call(e)},isBlob:function(e){return"[object Blob]"===o.call(e)},isFunction:c,isStream:function(e){return a(e)&&c(e.pipe)},isURLSearchParams:function(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams},isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)},forEach:u,merge:function e(){var t={};function r(r,n){"object"==typeof t[n]&&"object"==typeof r?t[n]=e(t[n],r):t[n]=r}for(var n=0,i=arguments.length;n<i;n++)u(arguments[n],r);return t},deepMerge:function e(){var t={};function r(r,n){"object"==typeof t[n]&&"object"==typeof r?t[n]=e(t[n],r):t[n]="object"==typeof r?e({},r):r}for(var n=0,i=arguments.length;n<i;n++)u(arguments[n],r);return t},extend:function(e,t,r){return u(t,(function(t,n){e[n]=r&&"function"==typeof t?i(t,r):t})),e},trim:function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")}};function h(e){return encodeURIComponent(e).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var y=function(e,t,r){if(!t)return e;var n;if(r)n=r(t);else if(d.isURLSearchParams(t))n=t.toString();else{var i=[];d.forEach(t,(function(e,t){null!=e&&(d.isArray(e)?t+="[]":e=[e],d.forEach(e,(function(e){d.isDate(e)?e=e.toISOString():d.isObject(e)&&(e=JSON.stringify(e)),i.push(h(t)+"="+h(e))})))})),n=i.join("&")}if(n){var o=e.indexOf("#");-1!==o&&(e=e.slice(0,o)),e+=(-1===e.indexOf("?")?"?":"&")+n}return e};function l(){this.handlers=[]}l.prototype.use=function(e,t){return this.handlers.push({fulfilled:e,rejected:t}),this.handlers.length-1},l.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},l.prototype.forEach=function(e){d.forEach(this.handlers,(function(t){null!==t&&e(t)}))};var p=l,f=function(e,t,r){return d.forEach(r,(function(r){e=r(e,t)})),e},v=function(e){return!(!e||!e.__CANCEL__)},g=function(e,t){d.forEach(e,(function(r,n){n!==t&&n.toUpperCase()===t.toUpperCase()&&(e[t]=r,delete e[n])}))},m=function(e,t,r,n,i){return function(e,t,r,n,i){return e.config=t,r&&(e.code=r),e.request=n,e.response=i,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code}},e}(new Error(e),t,r,n,i)},k=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],x=d.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),r=document.createElement("a");function n(e){var n=e;return t&&(r.setAttribute("href",n),n=r.href),r.setAttribute("href",n),{href:r.href,protocol:r.protocol?r.protocol.replace(/:$/,""):"",host:r.host,search:r.search?r.search.replace(/^\?/,""):"",hash:r.hash?r.hash.replace(/^#/,""):"",hostname:r.hostname,port:r.port,pathname:"/"===r.pathname.charAt(0)?r.pathname:"/"+r.pathname}}return e=n(window.location.href),function(t){var r=d.isString(t)?n(t):t;return r.protocol===e.protocol&&r.host===e.host}}():function(){return!0},E=d.isStandardBrowserEnv()?{write:function(e,t,r,n,i,o){var s=[];s.push(e+"="+encodeURIComponent(t)),d.isNumber(r)&&s.push("expires="+new Date(r).toGMTString()),d.isString(n)&&s.push("path="+n),d.isString(i)&&s.push("domain="+i),!0===o&&s.push("secure"),document.cookie=s.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},K=function(e){return new Promise((function(t,r){var n=e.data,i=e.headers;d.isFormData(n)&&delete i["Content-Type"];var o=new XMLHttpRequest;if(e.auth){var s=e.auth.username||"",a=e.auth.password||"";i.Authorization="Basic "+btoa(s+":"+a)}if(o.open(e.method.toUpperCase(),y(e.url,e.params,e.paramsSerializer),!0),o.timeout=e.timeout,o.onreadystatechange=function(){if(o&&4===o.readyState&&(0!==o.status||o.responseURL&&0===o.responseURL.indexOf("file:"))){var n,i,s,a,c,u="getAllResponseHeaders"in o?(n=o.getAllResponseHeaders(),c={},n?(d.forEach(n.split("\n"),(function(e){if(a=e.indexOf(":"),i=d.trim(e.substr(0,a)).toLowerCase(),s=d.trim(e.substr(a+1)),i){if(c[i]&&k.indexOf(i)>=0)return;c[i]="set-cookie"===i?(c[i]?c[i]:[]).concat([s]):c[i]?c[i]+", "+s:s}})),c):c):null,h={data:e.responseType&&"text"!==e.responseType?o.response:o.responseText,status:o.status,statusText:o.statusText,headers:u,config:e,request:o};!function(e,t,r){var n=r.config.validateStatus;!n||n(r.status)?e(r):t(m("Request failed with status code "+r.status,r.config,null,r.request,r))}(t,r,h),o=null}},o.onabort=function(){o&&(r(m("Request aborted",e,"ECONNABORTED",o)),o=null)},o.onerror=function(){r(m("Network Error",e,null,o)),o=null},o.ontimeout=function(){r(m("timeout of "+e.timeout+"ms exceeded",e,"ECONNABORTED",o)),o=null},d.isStandardBrowserEnv()){var c=E,u=(e.withCredentials||x(e.url))&&e.xsrfCookieName?c.read(e.xsrfCookieName):void 0;u&&(i[e.xsrfHeaderName]=u)}if("setRequestHeader"in o&&d.forEach(i,(function(e,t){void 0===n&&"content-type"===t.toLowerCase()?delete i[t]:o.setRequestHeader(t,e)})),e.withCredentials&&(o.withCredentials=!0),e.responseType)try{o.responseType=e.responseType}catch(t){if("json"!==e.responseType)throw t}"function"==typeof e.onDownloadProgress&&o.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&o.upload&&o.upload.addEventListener("progress",e.onUploadProgress),e.cancelToken&&e.cancelToken.promise.then((function(e){o&&(o.abort(),r(e),o=null)})),void 0===n&&(n=null),o.send(n)}))},w={"Content-Type":"application/x-www-form-urlencoded"};function b(e,t){!d.isUndefined(e)&&d.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var C,S={adapter:("undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process)?C=K:"undefined"!=typeof XMLHttpRequest&&(C=K),C),transformRequest:[function(e,t){return g(t,"Accept"),g(t,"Content-Type"),d.isFormData(e)||d.isArrayBuffer(e)||d.isBuffer(e)||d.isStream(e)||d.isFile(e)||d.isBlob(e)?e:d.isArrayBufferView(e)?e.buffer:d.isURLSearchParams(e)?(b(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString()):d.isObject(e)?(b(t,"application/json;charset=utf-8"),JSON.stringify(e)):e}],transformResponse:[function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,validateStatus:function(e){return e>=200&&e<300}};S.headers={common:{Accept:"application/json, text/plain, */*"}},d.forEach(["delete","get","head"],(function(e){S.headers[e]={}})),d.forEach(["post","put","patch"],(function(e){S.headers[e]=d.merge(w)}));var A=S;function P(e){e.cancelToken&&e.cancelToken.throwIfRequested()}var T=function(e){var t,r,n;return P(e),e.baseURL&&(n=e.url,!/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(n))&&(e.url=(t=e.baseURL,(r=e.url)?t.replace(/\/+$/,"")+"/"+r.replace(/^\/+/,""):t)),e.headers=e.headers||{},e.data=f(e.data,e.headers,e.transformRequest),e.headers=d.merge(e.headers.common||{},e.headers[e.method]||{},e.headers||{}),d.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||A.adapter)(e).then((function(t){return P(e),t.data=f(t.data,t.headers,e.transformResponse),t}),(function(t){return v(t)||(P(e),t&&t.response&&(t.response.data=f(t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))},R=function(e,t){t=t||{};var r={};return d.forEach(["url","method","params","data"],(function(e){void 0!==t[e]&&(r[e]=t[e])})),d.forEach(["headers","auth","proxy"],(function(n){d.isObject(t[n])?r[n]=d.deepMerge(e[n],t[n]):void 0!==t[n]?r[n]=t[n]:d.isObject(e[n])?r[n]=d.deepMerge(e[n]):void 0!==e[n]&&(r[n]=e[n])})),d.forEach(["baseURL","transformRequest","transformResponse","paramsSerializer","timeout","withCredentials","adapter","responseType","xsrfCookieName","xsrfHeaderName","onUploadProgress","onDownloadProgress","maxContentLength","validateStatus","maxRedirects","httpAgent","httpsAgent","cancelToken","socketPath"],(function(n){void 0!==t[n]?r[n]=t[n]:void 0!==e[n]&&(r[n]=e[n])})),r};function O(e){this.defaults=e,this.interceptors={request:new p,response:new p}}O.prototype.request=function(e){"string"==typeof e?(e=arguments[1]||{}).url=arguments[0]:e=e||{},(e=R(this.defaults,e)).method=e.method?e.method.toLowerCase():"get";var t=[T,void 0],r=Promise.resolve(e);for(this.interceptors.request.forEach((function(e){t.unshift(e.fulfilled,e.rejected)})),this.interceptors.response.forEach((function(e){t.push(e.fulfilled,e.rejected)}));t.length;)r=r.then(t.shift(),t.shift());return r},O.prototype.getUri=function(e){return e=R(this.defaults,e),y(e.url,e.params,e.paramsSerializer).replace(/^\?/,"")},d.forEach(["delete","get","head","options"],(function(e){O.prototype[e]=function(t,r){return this.request(d.merge(r||{},{method:e,url:t}))}})),d.forEach(["post","put","patch"],(function(e){O.prototype[e]=function(t,r,n){return this.request(d.merge(n||{},{method:e,url:t,data:r}))}}));var j=O;function D(e){this.message=e}D.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},D.prototype.__CANCEL__=!0;var N=D;function U(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var r=this;e((function(e){r.reason||(r.reason=new N(e),t(r.reason))}))}U.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},U.source=function(){var e;return{token:new U((function(t){e=t})),cancel:e}};var I=U;function V(e){var t=new j(e),r=i(j.prototype.request,t);return d.extend(r,j.prototype,t),d.extend(r,t),r}var H=V(A);H.Axios=j,H.create=function(e){return V(R(H.defaults,e))},H.Cancel=N,H.CancelToken=I,H.isCancel=v,H.all=function(e){return Promise.all(e)},H.spread=function(e){return function(t){return e.apply(null,t)}};var M=H,L=H;M.default=L;var B=M;class W extends Error{constructor(e,t="KeyknoxError",r=W){super(e),Object.setPrototypeOf(this,r.prototype),this.name=t}}class q extends W{constructor(e,t,r){super(e,"KeyknoxClientError",q),this.status=t,this.code=r}}class F extends W{constructor(){super("CloudKeyStorage is out of sync","CloudKeyStorageOutOfSyncError",F)}}class _ extends W{constructor(e){super(`Cloud entry '${e}' already exists`,"CloudEntryExistsError",_),this.cloudEntryName=e}}class G extends W{constructor(e){super(`Cloud entry '${e}' doesn't exist`,"CloudEntryDoesntExistError",G),this.cloudEntryName=e}}class $ extends W{constructor(e){super(`Key entry '${e}' already exists`,"KeyEntryExistsError",$),this.keyEntryName=e}}class z extends W{constructor(e){super(`Key entry '${e}' doesn't exist`,"KeyEntryDoesntExistError",z),this.keyEntryName=e}}class J extends W{constructor(){super("GroupSessionMessageInfo already exist","GroupTicketAlreadyExistsError",J)}}class X extends W{constructor(){super("Group ticket doesn't exist","GroupTicketDoesntExistError",X)}}class Y extends W{constructor(){super("Current user has no access to the group ticket","GroupTicketNoAccessError",Y)}}class Z{constructor(e,r,n,i){this.accessTokenProvider=e,this.axios=n||B.create({baseURL:r||Z.API_URL}),this.virgilAgent=i||new t.VirgilAgent("keyknox","0.4.0-next.3"),this.axios.interceptors.response.use(void 0,Z.responseErrorHandler)}v1Push(e,t,r){return n(this,void 0,void 0,(function*(){const n={meta:e,value:t},i=yield this.accessTokenProvider.getToken({service:"keyknox",operation:"put"}),o={headers:Z.getHeaders({accessToken:i,keyknoxHash:r,virgilAgent:this.virgilAgent})},s=yield this.axios.put("/keyknox/v1",n,o);return Z.getKeyknoxValueV1(s)}))}v1Pull(){return n(this,void 0,void 0,(function*(){const e=yield this.accessTokenProvider.getToken({service:"keyknox",operation:"get"}),t={headers:Z.getHeaders({accessToken:e,virgilAgent:this.virgilAgent})},r=yield this.axios.get("/keyknox/v1",t);return Z.getKeyknoxValueV1(r)}))}v1Reset(){return n(this,void 0,void 0,(function*(){const e=yield this.accessTokenProvider.getToken({service:"keyknox",operation:"delete"}),t={headers:Z.getHeaders({accessToken:e,virgilAgent:this.virgilAgent})},r=yield this.axios.post("/keyknox/v1/reset",void 0,t);return Z.getKeyknoxValueV1(r)}))}v2Push(e){return n(this,void 0,void 0,(function*(){const{root:t,path:r,key:n,identities:i,meta:o,value:s,keyknoxHash:a}=e,c={root:t,path:r,key:n,identities:i,meta:o,value:s},u=yield this.accessTokenProvider.getToken({service:"keyknox",operation:"put"}),d={headers:Z.getHeaders({accessToken:u,keyknoxHash:a,virgilAgent:this.virgilAgent})},h=yield this.axios.post("/keyknox/v2/push",c,d);return Z.getKeyknoxValueV2(h)}))}v2Pull(e){return n(this,void 0,void 0,(function*(){const{root:t,path:r,key:n,identity:i}=e,o={root:t,path:r,key:n,identity:i},s=yield this.accessTokenProvider.getToken({service:"keyknox",operation:"get"}),a={headers:Z.getHeaders({accessToken:s,virgilAgent:this.virgilAgent})},c=yield this.axios.post("/keyknox/v2/pull",o,a);return Z.getKeyknoxValueV2(c)}))}v2GetKeys(e){return n(this,void 0,void 0,(function*(){const{root:t,path:r,identity:n}=e,i={root:t,path:r,identity:n},o=yield this.accessTokenProvider.getToken({service:"keyknox",operation:"get"}),s={headers:Z.getHeaders({accessToken:o,virgilAgent:this.virgilAgent})};return(yield this.axios.post("/keyknox/v2/keys",i,s)).data}))}v2Reset(e){return n(this,void 0,void 0,(function*(){const{root:t,path:r,key:n,identity:i}=e,o={root:t,path:r,key:n,identity:i},s=yield this.accessTokenProvider.getToken({service:"keyknox",operation:"delete"}),a={headers:Z.getHeaders({accessToken:s,virgilAgent:this.virgilAgent})},c=yield this.axios.post("/keyknox/v2/reset",o,a);return Z.getKeyknoxValueV2(c)}))}static getKeyknoxValueV1(e){const{data:t,headers:r}=e;return{meta:t.meta,value:t.value,version:t.version,keyknoxHash:r["virgil-keyknox-hash"]}}static getKeyknoxValueV2(e){const{data:t,headers:r}=e;return{owner:t.owner,root:t.root,path:t.path,key:t.key,identities:t.identities,meta:t.meta,value:t.value,keyknoxHash:r["virgil-keyknox-hash"]}}static getHeaders(e){const{virgilAgent:t,accessToken:r,keyknoxHash:n}=e,i={"Virgil-Agent":t.value};return r&&(i.Authorization=`Virgil ${r.toString()}`),n&&(i["Virgil-Keyknox-Previous-Hash"]=n),i}static responseErrorHandler(e){const{response:t}=e;if(t){const{data:r}=t;return r&&r.code&&r.message?Promise.reject(new q(r.message,t.status,r.code)):Promise.reject(new q(e.message,t.status))}return Promise.reject(new q(e.message))}}Z.API_URL="https://api.virgilsecurity.com";class Q{constructor(e){this.crypto=e}decrypt(e,t,r,n){if(!t||!e){if(t||e)throw new TypeError("'metadata' or 'encryptedData' is empty");return t}return this.crypto.decryptThenVerifyDetached({value:t,encoding:"base64"},{value:e,encoding:"base64"},r,n).toString("base64")}encrypt(e,t,r){const{metadata:n,encryptedData:i}=this.crypto.signThenEncryptDetached({value:e,encoding:"base64"},t,r);return{metadata:n.toString("base64"),encryptedData:i.toString("base64")}}}const ee=50010;class te{constructor(e,t){this.myKeyknoxCrypto=e,this.keyknoxClient=t}get keyknoxCrypto(){return this.myKeyknoxCrypto}static create(e,t){const r=new Z(e);return new te(t,r)}v1Push(e,t,r,i){return n(this,void 0,void 0,(function*(){const{metadata:n,encryptedData:o}=this.myKeyknoxCrypto.encrypt(e,t,r),s=yield this.keyknoxClient.v1Push(n,o,i);return this.v1Decrypt(s,t,r)}))}v1Pull(e,t){return n(this,void 0,void 0,(function*(){const r=yield this.keyknoxClient.v1Pull();return this.v1Decrypt(r,e,t)}))}v1Reset(){return n(this,void 0,void 0,(function*(){return this.keyknoxClient.v1Reset()}))}v1Update(e){return n(this,void 0,void 0,(function*(){const{value:t,privateKey:r,publicKeys:n,keyknoxHash:i,newPrivateKey:o,newPublicKeys:s}=e;if(!o&&!s)return this.v1Push(t,r,n,i);const a=yield this.v1Pull(r,n),c=o||r,u=s||n,{metadata:d,encryptedData:h}=this.myKeyknoxCrypto.encrypt(a.value,c,u),y=yield this.keyknoxClient.v1Push(d,h,a.keyknoxHash);return this.v1Decrypt(y,c,u)}))}v1UpdateRecipients(e){return n(this,void 0,void 0,(function*(){const{privateKey:t,publicKeys:r,newPrivateKey:n,newPublicKeys:i}=e,o=yield this.v1Pull(t,r);if(!o.meta&&!o.value)return o;const s=n||t,a=i||r,{metadata:c,encryptedData:u}=this.myKeyknoxCrypto.encrypt(o.value,s,a),d=yield this.keyknoxClient.v1Push(c,u,o.keyknoxHash);return this.v1Decrypt(d,s,a)}))}v2Push(e){return n(this,void 0,void 0,(function*(){const{value:t,privateKey:n,publicKeys:i}=e,o=r(e,["value","privateKey","publicKeys"]),{metadata:s,encryptedData:a}=this.encrypt(t,n,i),c=yield this.keyknoxClient.v2Push(Object.assign(Object.assign({},o),{value:a,meta:s}));return this.v2Decrypt(c,n,i)}))}v2Pull(e){return n(this,void 0,void 0,(function*(){const{privateKey:t,publicKeys:n}=e,i=r(e,["privateKey","publicKeys"]),o=yield this.keyknoxClient.v2Pull(i);return this.v2Decrypt(o,t,n)}))}v2GetKeys(e){return n(this,void 0,void 0,(function*(){return this.keyknoxClient.v2GetKeys(e)}))}v2Reset(e){return n(this,void 0,void 0,(function*(){return this.keyknoxClient.v2Reset(e)}))}v1Decrypt(e,t,n){const{meta:i,value:o}=e,s=r(e,["meta","value"]),a=this.myKeyknoxCrypto.decrypt(i,o,t,n);return Object.assign(Object.assign({},s),{meta:i,value:a})}v2Decrypt(e,t,n){const{meta:i,value:o}=e,s=r(e,["meta","value"]),a=this.myKeyknoxCrypto.decrypt(i,o,t,n);return Object.assign(Object.assign({},s),{meta:i,value:a})}encrypt(e,t,r){return this.myKeyknoxCrypto.encrypt(e,t,r)}}class re{constructor(e){const{keyknoxManager:t,identity:r,privateKey:n,publicKey:i,root:o}=e;this.keyknoxManager=t,this.identity=r,this.privateKey=n,this.publicKey=i,this.root=o||re.DEFAULT_ROOT}static create(e){const{accessTokenProvider:t,identity:r,privateKey:n,publicKey:i,virgilCrypto:o,root:s}=e,a=te.create(t,new Q(o));return new re({keyknoxManager:a,identity:r,privateKey:n,publicKey:i,root:s})}store(e,t){return n(this,void 0,void 0,(function*(){const{epochNumber:r,sessionId:n,data:i}=e;let o=[this.identity],s=[this.publicKey];if(t){const e=Array.isArray(t)?t:[t];o=o.concat(e.map(e=>e.identity)),s=s.concat(e.map(e=>e.publicKey))}try{yield this.keyknoxManager.v2Push({identities:o,publicKeys:s,privateKey:this.privateKey,root:this.root,path:n,key:r.toString(),value:i})}catch(e){if(e instanceof q&&e.code===ee)throw new J;throw e}}))}retrieve(e,t,r){return n(this,void 0,void 0,(function*(){let n=this.identity,i=this.publicKey;if(t&&r)n=t,i=r;else if(Boolean(t)!==Boolean(r))throw new Error("You need to provide both 'identity' and 'publicKey'");const o=yield this.keyknoxManager.v2GetKeys({root:this.root,path:e,identity:n});if(!o.length)throw new X;const s=o.map(t=>this.keyknoxManager.v2Pull({root:this.root,path:e,key:t,identity:n,privateKey:this.privateKey,publicKeys:i}));try{return(yield Promise.all(s)).map(({key:e,path:t,identities:r,value:n})=>({identities:r,groupSessionMessageInfo:{sessionId:t,epochNumber:Number(e),data:n}}))}catch(e){throw re.throwIfRecipientIsNotFound(e),e}}))}addRecipients(e,t){return n(this,void 0,void 0,(function*(){const r=(yield this.keyknoxManager.v2GetKeys({root:this.root,path:e,identity:this.identity})).map(r=>n(this,void 0,void 0,(function*(){const n=yield this.keyknoxManager.v2Pull({root:this.root,path:e,key:r,identity:this.identity,privateKey:this.privateKey,publicKeys:this.publicKey});yield this.keyknoxManager.v2Push(Object.assign(Object.assign({},n),{identities:t.map(e=>e.identity),publicKeys:[this.publicKey,...t.map(e=>e.publicKey)],privateKey:this.privateKey}))})));try{yield Promise.all(r)}catch(e){throw re.throwIfRecipientIsNotFound(e),e}}))}addRecipient(e,t){return n(this,void 0,void 0,(function*(){return this.addRecipients(e,[t])}))}reAddRecipient(e,t){return n(this,void 0,void 0,(function*(){const r=(yield this.keyknoxManager.v2GetKeys({root:this.root,path:e,identity:this.identity})).map(r=>n(this,void 0,void 0,(function*(){const n=yield this.keyknoxManager.v2Pull({root:this.root,path:e,key:r,identity:this.identity,privateKey:this.privateKey,publicKeys:this.publicKey});yield this.removeRecipient(e,t.identity,Number(r)),yield this.keyknoxManager.v2Push({root:this.root,path:e,key:r,identities:[t.identity],value:n.value,privateKey:this.privateKey,publicKeys:[this.publicKey,t.publicKey],keyknoxHash:n.keyknoxHash})})));try{yield Promise.all(r)}catch(e){throw re.throwIfRecipientIsNotFound(e),e}}))}removeRecipient(e,t,r){return n(this,void 0,void 0,(function*(){yield this.keyknoxManager.v2Reset({identity:t,root:this.root,path:e,key:"number"==typeof r?r.toString():void 0})}))}delete(e){return n(this,void 0,void 0,(function*(){return this.keyknoxManager.v2Reset({root:this.root,path:e})}))}static throwIfRecipientIsNotFound(e){if("FoundationError"===e.name&&/recipient defined with id is not found/gi.test(e.message))throw new Y}}re.DEFAULT_ROOT="group-sessions";var ne="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var ie=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e,t){!function(r){var n=t,i=e&&e.exports==n&&e,o="object"==typeof ne&&ne;o.global!==o&&o.window!==o||(r=o);var s=function(e){this.message=e};(s.prototype=new Error).name="InvalidCharacterError";var a=function(e){throw new s(e)},c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",u=/[\t\n\f\r ]/g,d={encode:function(e){e=String(e),/[^\0-\xFF]/.test(e)&&a("The string to be encoded contains characters outside of the Latin1 range.");for(var t,r,n,i,o=e.length%3,s="",u=-1,d=e.length-o;++u<d;)t=e.charCodeAt(u)<<16,r=e.charCodeAt(++u)<<8,n=e.charCodeAt(++u),s+=c.charAt((i=t+r+n)>>18&63)+c.charAt(i>>12&63)+c.charAt(i>>6&63)+c.charAt(63&i);return 2==o?(t=e.charCodeAt(u)<<8,r=e.charCodeAt(++u),s+=c.charAt((i=t+r)>>10)+c.charAt(i>>4&63)+c.charAt(i<<2&63)+"="):1==o&&(i=e.charCodeAt(u),s+=c.charAt(i>>2)+c.charAt(i<<4&63)+"=="),s},decode:function(e){var t=(e=String(e).replace(u,"")).length;t%4==0&&(t=(e=e.replace(/==?$/,"")).length),(t%4==1||/[^+a-zA-Z0-9/]/.test(e))&&a("Invalid character: the string to be decoded is not correctly encoded.");for(var r,n,i=0,o="",s=-1;++s<t;)n=c.indexOf(e.charAt(s)),r=i%4?64*r+n:n,i++%4&&(o+=String.fromCharCode(255&r>>(-2*i&6)));return o},version:"0.1.0"};if(n&&!n.nodeType)if(i)i.exports=d;else for(var h in d)d.hasOwnProperty(h)&&(n[h]=d[h]);else r.base64=d}(ne)}));function oe(e){const t=ie.decode(e);if(!t.length)return new Map;const r=JSON.parse(t);return Object.keys(r).reduce((e,t)=>{const n=r[t];return e.set(t,{name:n.name,data:n.data,creationDate:new Date(n.creation_date),modificationDate:new Date(n.modification_date),meta:void 0===n.meta?null:n.meta}),e},new Map)}class se{constructor(e,t,r){this.cache=new Map,this.syncWasCalled=!1,this.keyknoxManager=e,this.privateKey=t,this.publicKeys=r}static create(e){const{accessTokenProvider:t,privateKey:r,publicKeys:n,virgilCrypto:i}=e,o=te.create(t,new Q(i));return new se(o,r,n)}storeEntries(e){return n(this,void 0,void 0,(function*(){return this.throwUnlessSyncWasCalled(),e.forEach(e=>{this.throwIfCloudEntryExists(e.name),this.cache.set(e.name,se.createCloudEntry(e))}),yield this.pushCacheEntries(),e.map(e=>this.cache.get(e.name))}))}storeEntry(e,t,r){return n(this,void 0,void 0,(function*(){const[n]=yield this.storeEntries([{name:e,data:t,meta:r}]);return n}))}updateEntry(e,t,r){return n(this,void 0,void 0,(function*(){this.throwUnlessSyncWasCalled(),this.throwUnlessCloudEntryExists(e);const n=se.createCloudEntry({name:e,data:t,meta:r},this.cache.get(e).creationDate);return this.cache.set(e,n),yield this.pushCacheEntries(),n}))}retrieveEntry(e){return this.throwUnlessSyncWasCalled(),this.throwUnlessCloudEntryExists(e),this.cache.get(e)}retrieveAllEntries(){return this.throwUnlessSyncWasCalled(),Array.from(this.cache.values())}existsEntry(e){return this.throwUnlessSyncWasCalled(),this.cache.has(e)}deleteEntry(e){return n(this,void 0,void 0,(function*(){yield this.deleteEntries([e])}))}deleteEntries(e){return n(this,void 0,void 0,(function*(){this.throwUnlessSyncWasCalled(),e.forEach(e=>{this.throwUnlessCloudEntryExists(e),this.cache.delete(e)}),yield this.pushCacheEntries()}))}deleteAllEntries(){return n(this,void 0,void 0,(function*(){this.cache.clear(),this.decryptedKeyknoxValue=yield this.keyknoxManager.v1Reset()}))}updateRecipients(e){return n(this,void 0,void 0,(function*(){this.throwUnlessSyncWasCalled();const{newPrivateKey:t,newPublicKeys:r}=e;this.decryptedKeyknoxValue=yield this.keyknoxManager.v1UpdateRecipients({newPrivateKey:t,newPublicKeys:r,privateKey:this.privateKey,publicKeys:this.publicKeys}),this.privateKey=t||this.privateKey,this.publicKeys=r||this.publicKeys,this.cache=oe(this.decryptedKeyknoxValue.value)}))}retrieveCloudEntries(){return n(this,void 0,void 0,(function*(){this.decryptedKeyknoxValue=yield this.keyknoxManager.v1Pull(this.privateKey,this.publicKeys),this.cache=oe(this.decryptedKeyknoxValue.value),this.syncWasCalled=!0}))}throwUnlessSyncWasCalled(){if(!this.syncWasCalled)throw new F}throwUnlessCloudEntryExists(e){if(!this.cache.has(e))throw new G(e)}throwIfCloudEntryExists(e){if(this.cache.has(e))throw new _(e)}pushCacheEntries(){return n(this,void 0,void 0,(function*(){const e=function(e){const t={};return e.forEach((e,r)=>{t[r]={data:e.data,meta:e.meta,creation_date:Number(e.creationDate),name:e.name,modification_date:Number(e.modificationDate)},null===t[r].meta&&delete t[r].meta}),ie.encode(JSON.stringify(t))}(this.cache);this.decryptedKeyknoxValue=yield this.keyknoxManager.v1Push(e,this.privateKey,this.publicKeys,this.decryptedKeyknoxValue.keyknoxHash),this.cache=oe(this.decryptedKeyknoxValue.value)}))}static createCloudEntry(e,t){const r=new Date;return{name:e.name,data:e.data,meta:void 0===e.meta?null:e.meta,creationDate:t||r,modificationDate:r}}}class ae{constructor(e,t){this.formatKeyEntry=e=>Object.assign(Object.assign({},e),{name:e.name.replace(this.prefix,"")}),this.prefix=`_VIRGIL_IDENTITY=${e}.`,this.prefixRegExp=new RegExp(`^${this.prefix}`),this.keyEntryStorage=t}save(e){return n(this,void 0,void 0,(function*(){const t=yield this.keyEntryStorage.save(Object.assign(Object.assign({},e),{name:this.getKeyEntryName(e.name)}));return this.formatKeyEntry(t)}))}load(e){return n(this,void 0,void 0,(function*(){const t=yield this.keyEntryStorage.load(this.getKeyEntryName(e));return null===t?null:this.formatKeyEntry(t)}))}exists(e){return this.keyEntryStorage.exists(this.getKeyEntryName(e))}remove(e){return this.keyEntryStorage.remove(this.getKeyEntryName(e))}list(){return n(this,void 0,void 0,(function*(){return(yield this.getAllKeyEntries()).map(this.formatKeyEntry)}))}update(e){return n(this,void 0,void 0,(function*(){const t=yield this.keyEntryStorage.update(Object.assign(Object.assign({},e),{name:this.getKeyEntryName(e.name)}));return this.formatKeyEntry(t)}))}clear(){return n(this,void 0,void 0,(function*(){const e=yield this.getAllKeyEntries();for(const t of e)yield this.keyEntryStorage.remove(t.name)}))}getKeyEntryName(e){return`${this.prefix}${e}`}getAllKeyEntries(){return n(this,void 0,void 0,(function*(){return(yield this.keyEntryStorage.list()).filter(e=>this.prefixRegExp.test(e.name))}))}}const ce="k_cda",ue="k_mda";function de(e){return{name:e.name,value:e.data,meta:Object.assign(Object.assign({},e.meta),{[ce]:e.creationDate.toISOString(),[ue]:e.modificationDate.toISOString()})}}class he{constructor(e,t,r){this.cloudKeyStorage=t,this.keyEntryStorageWrapper=new ae(e,r)}static create(e){const{virgilCrypto:t,identity:r,accessTokenProvider:n,privateKey:i,publicKeys:o}=e,s=se.create({accessTokenProvider:n,privateKey:i,publicKeys:o,virgilCrypto:t});return new he(r,s,e.keyEntryStorage)}storeEntries(e){return n(this,void 0,void 0,(function*(){const t=e.map(e=>this.throwIfKeyEntryExists(e.name));yield Promise.all(t);const r=(yield this.cloudKeyStorage.storeEntries(e)).map(e=>n(this,void 0,void 0,(function*(){const t=de(e);return this.keyEntryStorageWrapper.save(t)})));return Promise.all(r)}))}storeEntry(e,t,r){return n(this,void 0,void 0,(function*(){const[n]=yield this.storeEntries([{name:e,data:t,meta:r}]);return n}))}updateEntry(e,t,r){return n(this,void 0,void 0,(function*(){yield this.throwUnlessKeyEntryExists(e);const n=de(yield this.cloudKeyStorage.updateEntry(e,t,r));yield this.keyEntryStorageWrapper.update(n)}))}retrieveEntry(e){return n(this,void 0,void 0,(function*(){return yield this.throwUnlessKeyEntryExists(e),this.keyEntryStorageWrapper.load(e)}))}retrieveAllEntries(){return this.keyEntryStorageWrapper.list()}existsEntry(e){return this.keyEntryStorageWrapper.exists(e)}deleteEntry(e){return this.deleteEntries([e])}deleteEntries(e){return n(this,void 0,void 0,(function*(){yield this.cloudKeyStorage.deleteEntries(e);const t=e.map(e=>this.keyEntryStorageWrapper.remove(e));yield Promise.all(t)}))}deleteAllEntries(){return n(this,void 0,void 0,(function*(){yield this.cloudKeyStorage.deleteAllEntries(),yield this.keyEntryStorageWrapper.clear()}))}updateRecipients(e){return n(this,void 0,void 0,(function*(){const{newPrivateKey:t,newPublicKeys:r}=e;return this.cloudKeyStorage.updateRecipients({newPrivateKey:t,newPublicKeys:r})}))}sync(){return n(this,void 0,void 0,(function*(){yield this.cloudKeyStorage.retrieveCloudEntries();const e=this.cloudKeyStorage.retrieveAllEntries(),t=e.reduce((e,t)=>(e[t.name]=t,e),{}),r=yield this.keyEntryStorageWrapper.list(),n=r.reduce((e,t)=>(e[t.name]=t,e),{}),i=[],o=[],s=[];return e.forEach(e=>{const t=n[e.name];if(t){const{modificationDate:r}=function(e){if(!e.meta)throw new TypeError("Invalid 'IKeyEntry'");return{creationDate:new Date(e.meta[ce]),modificationDate:new Date(e.meta[ue])}}(t);if(e.modificationDate>r)return o.push(e.name)}else i.push(e.name)}),r.forEach(e=>{t[e.name]||s.push(e.name)}),this.syncKeyStorage(i,o,s)}))}throwUnlessKeyEntryExists(e){return n(this,void 0,void 0,(function*(){if(!(yield this.keyEntryStorageWrapper.exists(e)))throw new z(e)}))}throwIfKeyEntryExists(e){return n(this,void 0,void 0,(function*(){if(yield this.keyEntryStorageWrapper.exists(e))throw new $(e)}))}syncKeyStorage(e,t,r){return n(this,void 0,void 0,(function*(){const i=r.map(e=>n(this,void 0,void 0,(function*(){yield this.keyEntryStorageWrapper.remove(e)}))),o=t.map(e=>n(this,void 0,void 0,(function*(){const t=de(this.cloudKeyStorage.retrieveEntry(e));yield this.keyEntryStorageWrapper.update(t)}))),s=e.map(e=>n(this,void 0,void 0,(function*(){const t=de(this.cloudKeyStorage.retrieveEntry(e));yield this.keyEntryStorageWrapper.save(t)})));yield Promise.all([...i,...o,...s])}))}}e.CloudEntryDoesntExistError=G,e.CloudEntryExistsError=_,e.CloudGroupTicketStorage=re,e.CloudKeyStorage=se,e.CloudKeyStorageOutOfSyncError=F,e.GroupTicketAlreadyExistsError=J,e.GroupTicketDoesntExistError=X,e.GroupTicketNoAccessError=Y,e.KeyEntryDoesntExistError=z,e.KeyEntryExistsError=$,e.KeyknoxClient=Z,e.KeyknoxClientError=q,e.KeyknoxCrypto=Q,e.KeyknoxError=W,e.KeyknoxManager=te,e.SyncKeyStorage=he,Object.defineProperty(e,"__esModule",{value:!0})}));
